# File: .gitlab-ci.yml
stages:
  - test
  - quality
  - security
  - build
  - deploy

variables:
  GO_VERSION: "1.21"
  DOCKER_IMAGE: "registry.gitlab.com/kfilin/watchtower-masterbot"
  DOCKER_TAG: "$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA"

cache:
  paths:
    - .cache/go-build
    - go/pkg/mod/
  key: "$CI_COMMIT_REF_SLUG"

before_script:
  - export GO111MODULE=on
  - export GOPRIVATE=gitlab.com/kfilin/*

# === TESTING STAGE ===

unit_tests:
  stage: test
  image: golang:$GO_VERSION
  script:
    - echo "üöÄ Starting unit tests for watchtower-masterbot"
    - go version
    - go mod download
    - echo "üìù Running go vet..."
    - go vet ./...
    - echo "üß™ Running tests..."
    - go test -v -race ./...
  artifacts:
    when: always
    reports:
      junit: report.xml
  tags:
    - docker

integration_tests:
  stage: test
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - apk add --no-cache curl
  script:
    - echo "üê≥ Building Docker image for integration tests..."
    - docker build -t $DOCKER_IMAGE:integration-test .
    
    - echo "üöÄ Starting container..."
    - |
      docker run -d --name watchtower-test \
        -e TELEGRAM_BOT_TOKEN="test-token-12345" \
        -e ADMIN_USER_ID="304528450" \
        -e HEALTH_PORT="18080" \
        -p 18080:18080 \
        $DOCKER_IMAGE:integration-test
    
    - sleep 10
    
    - |
      echo "üîç Testing health endpoints..."
      response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:18080/health || echo "curl_failed")
      if [ "$response" = "200" ]; then
        echo "‚úÖ Health endpoint: HTTP 200"
      else
        echo "‚ùå Health endpoint failed: $response"
        docker logs watchtower-test
        exit 1
      fi
    - docker stop watchtower-test
    - docker rm watchtower-test
  only:
    - main
    - develop
  tags:
    - docker

# === QUALITY STAGE ===

code_format:
  stage: quality
  image: golang:$GO_VERSION
  script:
    - go mod download
    - |
      UNFORMATTED=$(gofmt -l .)
      if [ -n "$UNFORMATTED" ]; then
        echo "‚ùå Code formatting issues found:"
        echo "$UNFORMATTED"
        exit 1
      else
        echo "‚úÖ Code is properly formatted"
      fi
  tags:
    - docker

static_analysis:
  stage: quality
  image: golang:$GO_VERSION
  script:
    - go mod download
    - go vet ./...
    - echo "‚úÖ Go vet completed"
  tags:
    - docker

# === SECURITY STAGE ===

container_scan:
  stage: security
  image: 
    name: aquasec/trivy:latest
    entrypoint: [""]
  variables:
    TRIVY_NO_PROGRESS: "true"
  script:
    - echo "üîí Scanning container for vulnerabilities..."
    - docker build -t $DOCKER_IMAGE:security-scan .
    - trivy image --severity HIGH,CRITICAL $DOCKER_IMAGE:security-scan
  only:
    - main
    - develop
  tags:
    - docker

# === BUILD STAGE ===

build_docker:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - |
      echo "üèóÔ∏è Building Docker image..."
      docker build \
        -t $DOCKER_IMAGE:$DOCKER_TAG \
        -t $DOCKER_IMAGE:latest \
        .
    - |
      echo "üì¶ Pushing Docker images..."
      docker push $DOCKER_IMAGE:$DOCKER_TAG
      docker push $DOCKER_IMAGE:latest
    - echo "‚úÖ Images pushed: $DOCKER_IMAGE:$DOCKER_TAG"
  only:
    - main
    - develop
    - tags
  tags:
    - docker

# === DEPLOY STAGE ===

deploy_staging:
  stage: deploy
  image: alpine:latest
  script:
    - |
      echo "üöÄ Deploying to staging..."
      echo "üì¶ Image: $DOCKER_IMAGE:$DOCKER_TAG"
      echo "‚úÖ Staging deployment completed (simulated)"
  environment:
    name: staging
    url: https://staging-watchtower.yourdomain.com
  only:
    - develop
  when: manual
  tags:
    - docker

deploy_production:
  stage: deploy
  image: alpine:latest
  script:
    - |
      echo "üéØ Deploying to PRODUCTION..."
      echo "üì¶ Image: $DOCKER_IMAGE:$DOCKER_TAG"
      echo "‚úÖ Production deployment completed (simulated)"
  environment:
    name: production
    url: https://watchtower.yourdomain.com
  only:
    - main
  when: manual
  tags:
    - docker

workflow:
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - when: never
