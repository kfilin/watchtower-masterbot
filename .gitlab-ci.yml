stages:
  - test
  - security-scan
  - build
  - docker-build
  - deploy

variables:
  DOCKER_IMAGE: $CI_REGISTRY_IMAGE
  DOCKER_TAG: $CI_COMMIT_SHORT_SHA

test:
  stage: test
  image: golang:1.21-alpine
  script:
    - go version
    - go mod download
    - go vet ./...
    - go test -v ./...
  only:
    - master

security-scan:
  stage: security-scan
  image: aquasec/trivy:latest
  script:
    - trivy --version
    - trivy filesystem --exit-code 0 --no-progress .
    - echo "Security scan completed - review findings above"
  allow_failure: true
  only:
    - master

build:
  stage: build
  image: golang:1.21-alpine
  script:
    - go version
    - go mod download
    - CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o watchtower-masterbot .
  artifacts:
    paths:
      - watchtower-masterbot
  only:
    - master

docker-build:
  stage: docker-build
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - docker info
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
    - docker build -t $DOCKER_IMAGE:latest -t $DOCKER_IMAGE:$DOCKER_TAG .
    - docker push $DOCKER_IMAGE:latest
    - docker push $DOCKER_IMAGE:$DOCKER_TAG
  dependencies:
    - build
  only:
    - master

deploy-staging:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - echo "ðŸš€ Simulating deployment to staging..."
    - kubectl version --client
    - echo "Deployment would happen here with proper kubeconfig"
  environment:
    name: staging
  only:
    - master
  when: manual

deploy-production:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - echo "ðŸŽ¯ Simulating deployment to production..."
    - kubectl version --client
    - echo "Deployment would happen here with proper kubeconfig"
  environment:
    name: production
  only:
    - master
  when: manual
