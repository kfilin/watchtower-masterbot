# .gitlab-ci.yml - FIXED VERSION
stages:
  - test
  - security-scan
  - build
  - docker-build
  - deploy

variables:
  DOCKER_IMAGE: $CI_REGISTRY_IMAGE
  DOCKER_TAG: $CI_COMMIT_SHORT_SHA

# Test stage
test:
  stage: test
  image: golang:1.21-alpine
  script:
    - go version
    - go mod download
    - go vet ./...
    - go test -v ./...
  artifacts:
    paths:
      - coverage.txt
  only:
    - master

# Security scan - SIMPLIFIED VERSION (no Docker dependency)
security_scan:
  stage: security-scan
  image: aquasec/trivy:latest
  script:
    - trivy --version
    - trivy filesystem --exit-code 0 --no-progress .  # Exit code 0 to not fail pipeline
    - echo "Security scan completed - review findings above"
  dependencies: []
  allow_failure: true  # Don't fail pipeline on security findings
  only:
    - master

# Build Go binary
build:
  stage: build
  image: golang:1.21-alpine
  script:
    - go version
    - go mod download
    - CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o watchtower-masterbot .
  artifacts:
    paths:
      - watchtower-masterbot
  only:
    - master

# Docker build
build_docker:
  stage: docker-build
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - docker info
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
    - docker build -t $DOCKER_IMAGE:latest -t $DOCKER_IMAGE:$DOCKER_TAG .
    - docker push $DOCKER_IMAGE:latest
    - docker push $DOCKER_IMAGE:$DOCKER_TAG
  dependencies:
    - build
  only:
    - master

# Staging deployment
deploy_staging:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - echo "ðŸš€ Deploying Watchtower-MasterBot to Kubernetes staging..."
    - kubectl version --client
    - echo "KUBECONFIG would be set here for actual deployment"
    - echo "Simulating: kubectl apply -f k8s/"
    - echo "âœ… Watchtower-MasterBot staging deployment completed (simulated)"
  environment:
    name: staging
  only:
    - master
  when: manual

# Production deployment
deploy_production:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - echo "ðŸŽ¯ Deploying Watchtower-MasterBot to Kubernetes PRODUCTION..."
    - kubectl version --client
    - echo "KUBECONFIG would be set here for actual deployment"
    - echo "Simulating: kubectl apply -f k8s/"
    - echo "âœ… Watchtower-MasterBot production deployment completed (simulated)"
  environment:
    name: production
  only:
    - master
  when: manual

workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
