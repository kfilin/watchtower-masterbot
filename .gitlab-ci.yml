# .gitlab-ci.yml - FIXED VERSION
stages:
  - test
  - security-scan
  - build
  - docker-build
  - deploy

variables:
  DOCKER_IMAGE: $CI_REGISTRY_IMAGE
  DOCKER_TAG: $CI_COMMIT_SHORT_SHA

# Test stage
test:
  stage: test
  image: golang:1.21-alpine
  script:
    - go version
    - go mod download
    - go vet ./...
    - go test -v ./...
  artifacts:
    paths:
      - coverage.txt
  only:
    - master

# Security scan
security_scan:
  stage: security-scan
  image: alpine:latest
  services:
    - docker:dind
  script:
    - apk add --no-cache docker
    - docker version
    - |
      if [ -z "$TRIVY_VERSION" ]; then
        TRIVY_VERSION="0.45.0"
      fi
      wget -qO- https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz | tar -zx -C /usr/local/bin trivy
      chmod +x /usr/local/bin/trivy
    - trivy --version
    - trivy filesystem --exit-code 1 --no-progress /
  dependencies: []
  only:
    - master

# Build Go binary
build:
  stage: build
  image: golang:1.21-alpine
  script:
    - go version
    - go mod download
    - CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o watchtower-masterbot .
  artifacts:
    paths:
      - watchtower-masterbot
  only:
    - master

# Docker build
build_docker:
  stage: docker-build
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  script:
    - docker version
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $DOCKER_IMAGE:latest -t $DOCKER_IMAGE:$DOCKER_TAG .
    - docker push $DOCKER_IMAGE:latest
    - docker push $DOCKER_IMAGE:$DOCKER_TAG
  dependencies:
    - build
  only:
    - master

# Staging deployment
deploy_staging:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - echo "ðŸš€ Deploying Watchtower-MasterBot to Kubernetes staging..."
    - kubectl config use-context staging-cluster
    - kubectl apply -f k8s/
    - kubectl rollout status deployment/watchtower-masterbot --timeout=300s
    - echo "âœ… Watchtower-MasterBot staging deployment completed"
  environment:
    name: staging
  only:
    - master
  when: manual

# Production deployment
deploy_production:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - echo "ðŸŽ¯ Deploying Watchtower-MasterBot to Kubernetes PRODUCTION..."
    - kubectl config use-context production-cluster
    - kubectl apply -f k8s/
    - kubectl rollout status deployment/watchtower-masterbot --timeout=300s
    - echo "âœ… Watchtower-MasterBot production deployment completed"
  environment:
    name: production
  only:
    - master
  when: manual

workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
